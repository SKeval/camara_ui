import 'dart:developer';

import 'package:camera/camera.dart';
import 'package:farm_ar/features/plant_disease_detection/screens/disease_info_screen.dart';
import 'package:farm_ar/models/plant_disease_model.dart';
import 'package:farm_ar/routes.dart';
import 'package:farm_ar/utils/navigation/navigation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_tflite/flutter_tflite.dart';
// import 'package:tflite/tflite.dart';


import '../../../utils/asset_strings.dart';

List<CameraDescription>? camera;

class PlantDieseaseDetectionScreen extends StatefulWidget {
  static const id = AppRoutes.plantDiseaseScreen;
  const PlantDieseaseDetectionScreen({super.key});

  @override
  State<StatefulWidget> createState() => _PlantDieseaseDetectionScreenState();
}

class _PlantDieseaseDetectionScreenState
    extends State<PlantDieseaseDetectionScreen> {
  @override
  void initState() {
    loadCameras();
    loadModel();
    runModel();
    super.initState();
  }

  // CameraImage? cameraImage;
  // CameraController? cameraController;
  // String output = 'not_detected';

  CameraImage? cameraImage;
  CameraController? cameraController;
  String output = '';

  loadCameras() async {
    log("loaded cams");
    cameraController = CameraController(camera![0], ResolutionPreset.ultraHigh);
    cameraController!.initialize().then((value) {
      if (!mounted) {
        return;
      } else {
        setState(() {
          cameraController!.startImageStream((image) {
            cameraImage = image;
          });
        });
      }
    });
  }

  loadModel() async {
    try {
      await Tflite.loadModel(
              model: "assets/machine_learning/rice.tflite",
              labels: "assets/machine_learning/labels.txt")
          .onError((error, stackTrace) {
        log(error.toString());
        log(stackTrace.toString());
        return null;
      });
    } catch (e) {
      log(e.toString());
    }
  }

  runModel() async {
    log("loaded run model");
    if (cameraImage != null) {
      try {
        log("got camera image");
        var predictions = await Tflite.runModelOnFrame(
            bytesList: cameraImage!.planes.map((e) {
              return e.bytes;
            }).toList(),
            imageHeight: cameraImage!.height,
            imageWidth: cameraImage!.width,
            imageMean: 127.5,
            imageStd: 127.5,
            rotation: 90,
            numResults: 2,
            threshold: 0.1,
            asynch: true);
        for (var element in predictions!) {
          setState(() {
            log("message");
            output = element['label'].toString();
          });
        }
      } catch (e) {
        log(e.toString());
      }
    }
  }

  // runModel() async {
  //   log("loaded run model");
  //   if (cameraImage != null) {
  //     try {
  //       log("got camera image");
  //       var predictions = await Tflite.runModelOnFrame(
  //           bytesList: cameraImage!.planes.map((e) {
  //             return e.bytes;
  //           }).toList(),
  //           imageHeight: cameraImage!.height,
  //           imageWidth: cameraImage!.width,
  //           imageMean: 127.5,
  //           imageStd: 127.5,
  //           rotation: 90,
  //           numResults: 2,
  //           threshold: 0.1,
  //           asynch: true);
  //       for (var element in predictions!) {
  //         setState(() {
  //           log("message");
  //           output = element['label'].toString();
  //         });
  //       }
  //     } catch (e) {
  //       log(e.toString());
  //     }
  //   }
  // }

  // loadModel() async {
  //   try {
  //     await Tflite.loadModel(
  //             model: "assets/machine_learning/rice.tflite",
  //             labels: "assets/machine_learning/labels.txt")
  //         .onError((error, stackTrace) {
  //       log(error.toString());
  //       log(stackTrace.toString());
  //       return null;
  //     });
  //   } catch (e) {
  //     log(e.toString());
  //   }
  // }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Plant Disease Detection ")),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(16),
            child: SizedBox(
              height: MediaQuery.of(context).size.height * 0.7,
              width: MediaQuery.of(context).size.width,
              child: cameraController!.value.isInitialized
                  ? AspectRatio(
                      aspectRatio: cameraController!.value.aspectRatio,
                      child: CameraPreview(cameraController!),
                    )
                  : const SizedBox(),
            ),
          ),
          Text(
            output,
            style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
          TextButton(
              onPressed: (() async {
                //loadModel();
                runModel();
              }),
              child: const Text("Detect")),
          Visibility(
              visible: output == "Pink bollworm" || output == "Rice Case Worm",
              child: InkWell(
                onTap: () {
                  if (output == "Pink bollworm") {
                    PlantDiseaseInfoModel infoModel = PlantDiseaseInfoModel(
                        images: [
                          Assets.riceCase,
                          Assets.riceCase,
                          Assets.riceCase
                        ],
                        pMes:
                            "Comprehensive plant protection: Deep summer ploughing to expose pupae surviving in the soil Crop rotation with non-preferred hosts like ragi, maize, rice, cowpea. Apply 25% organic manures, 75% chemical fertilizers Inter cropping of cotton with cowpea, soybean, greengram, blackgram, in 1:2 ratio    (Korra, goruchikkudu) to enhance the natural enemy population. Non B.T. Cultivation of Cotton (Refugia).  Sowing of border crop with jowar or maize is recommended to conserve the natural enemies. Use of trap crops to attract insects like castor for Spodoptera litura, Marigold for Helicoverpa armigera is recommended. Insects feeding on these crops will be collected and destroyed. Selection of short duration varieties to avoid pink boll worm infestation at later stages of crop growth. Install pheromone traps @ 4/acre for monitoring of American bollworm, spotted bollworms, pink bollworm and tobacco caterpillar. Use specific lures for each insect pest species and change it after every 15 - 20 days. Trapped moths should be removed daily. If moth catches are observed above ETL then spray with recommended insecticides. Applying drug coating to stem. Fixing yellow glue stick sheets. Erection of bird perches @ 15-20/acre Collect and destroy Blind flowers which appears in early stage of crop. Release Trichogramma cells. Spray neem seed decoction. Spraying prescribed insecticides. Complete cropping crop in 180 - 200 days and plow the residues into the soil",
                        pCause:
                            "Mode of damage to cotton crop by pink bollworm is The damage caused by the pink borer is not visible on the surface. It is known only when the pods crack.  Because soon after emerging from the cocoons, the small larvae make invisible holes on the buds or pods and enter and spend their entire life in the pods.  By feeding on the material in the flowers that are growing in anticipation of the tender buds, the attractive leaves are folded rather than unfurled. These are called Guddipulu.  Although the flowers are shed when the mature buds are expected, damage is caused by pollen eating the ovules inside. In this way, the buds and flowers will fall if you expect them in the first stage.  When the tender pods are harvested, they do not fall off, the pod size does not increase, but the pods do not burst properly and dry up, forming blind pods.  To identify the damage of this insect, if you open the eggs and pods in the field and look inside, you will notice small or large pink caterpillars inside the pod. Pink boll weevil can cause loss of cotton colour, quality and weight loss in cotton, resulting in a significant reduction in yield.",
                        tips:
                            "The pink boll worm can be controlled by different management practices like preventive measures, management practices during non crop periods, before sowing, during cropping season, post harvest management etc. Preventive measures: pink borer should be avoided by following comprehensive management practices.  These are various measures to be taken mainly during non-crop, pre-sowing, harvest and post-harvest periods.  Management practices non-crop periods: Deep digging during dry season can effectively kill the cellular stages of the insect.  Seeds obtained from ginning of cotton infected by pink boll worm should not be stored. If you do that, it will increase in the next crop season. Cotton which is infected with pink worm should not be stored either at the farmer's house or at the ginning mills.    Management practices before sowing period: The practice of crop rotation should be followed every two - three years.  Selection of short duration varieties and timely sowing can reduce pink bollworm infestation to a great extent. While sowing Bt cotton in 5 rows of non Bt around the cotton. Cotton should be sown as per duty.  Weeds like Thuteribenda should be kept free in the cotton field and around the paddy field.  Care should be taken to ensure that there is no Bhendi (Okra) crop near the cotton crop.  As far as possible, all the farmers in an area/village should sow cotton at the same time i.e., within a week, as the infestation of pink pod borer will be greatly reduced on the crop.   Management practices during cropping period: To monitor the presence of pink bollworm from 45 days after sowing of cotton crop, 4 sex attractant baskets per acre should be installed and plant protection measures should be taken immediately if 7 or 8 moths are observed in the baskets for three consecutive days or if 10% blind flowers or 10% pods are observed in the field. Placing 8 sex attractant baskets per acre can control the pest infestation to some extent.  Estimate the pest infestation based on the sex attractant baskets and release 4 cards of Trichogrammatoidea bactrae egg parasitoid per acre when the loss limit is reached.  Apply 5% neem seed decoction or 5 ml as soon as the insect damage threshold level is exceeded. (1500 ppm) neem oil should be mixed with a litre of water and sprayed.  Quinalphos 2.0 ml. or Thiodicarb 1.5 g or Profenophos 2 ml. or chlorpyrifos 2.5 ml. or Emamectin benzoate 0.5 g. Or Spinatorum 0.9 ml. Mix it with a litre of water and spray it.  Only once or twice during crop season Apply synthetic pyrethroids Cypermethrin 25% e.c.. 1.0 ml or lambda Cyhalothrin 5.0% e.c. 1.0 ml or thiomethoxam + Lambda Cyhalothrin 0.4 ml. or Profenophos + Cypermethrin 2 ml. or chlorpyrifos, + Cypermethrin 2 ml. It can be mixed with a litre of water and sprayed. Repeated spraying of synthetic pyrethroids on cotton crop may increase the incidence of sap-sucking insects.   Management practices after post-harvest period: Cotton should be removed after seven months even if waterlogged. By lengthening the dishes, there is a chance that the pest infestation in the next crop will increase at an early stage.  Cultivation of other semi-arid crops as a second crop where water availability is available can not only leads to crop rotation but also generate more income than the income from cotton Sheep, goats and cattle should be grazed in field after harvest.  Cotton stems should be tilled into the ground either with a Sectorer or a Rotavator.  Cotton stems should not be stored for use in stoves at homes.  After harvesting, dry stems and unopened pods should be removed and burned, followed by composting of the soil to destroy the cellular stages of the insect. If the soil is well watered after removing cotton stems, the larvae and cellular stages inside the soil will die.",
                        organicControl:
                            "Inter cropping of cotton with cowpea/soybean/greengram/blackgram/foxtail/cluster beans in 1:2 ratio to enhance the natural enemy population Stem application with monocrotophos: water in 1:4 ratio or Imidacloprid : water in 1: 20 ratio at 30. 45 and 60 DAS for effective ecofriendly control of jassids, aphids and mealy bugs ﻿﻿Spray with NSKE 5% or Neem oil against sucking pests",
                        chemControl:
                            "Seed treatment with Imidacloprid 70 WS or thiomethaxam 70 WS @ 4 - 5 g per kg seed which protects the crop from sucking pests upto 30 DAS ETL based application of insecticides with quinalphos @ 2.5 ml or Chlorpyriphos @ 3 ml or Acephate@ 1.5 g or Triazophos @ 2 ml or Thiodicarb 1.5 g per liter of water Spray with Indoxacarb @1 ml or Spinosad @ 0.3 ml or Emamectin benzoate 0.5 g or Flubendamide 0.3 ml or Chlorantraniliprole 0.3 ml per liter of water if the incidence of H. armigera is high Spray with 1 ml Novaluron or lufenuron or 1.5 g Thiodicarb per liter of water.",
                        rCause:
                            "The mother moth lays eggs in clusters or singly on the lower sides of young leaves, on young twigs, on buds, on young pods, on bracts.  The tiny larvae that emerge from the cocoons into the flower and feed on the internal contents, turning them into blind flowers. The tiny larvae make holes in the pods that pare too small to be seen by the eye and enter inside. Later the hole made in the pods gets clogged and the worm stays in the pod and eats the seeds and damages the cotton. Cotton colour and quality are completely damaged. As the insect spends the entire larval stage inside the pod, damage can be detected only after the pod is cracked.  The pods that affect by the insect will be ripen early without fully developing",
                        products: [
                          'Imidacloprid 6.0% SL\n, Lambda-cyhalothrin 4.0% SL',
                          'Malathion 50.0% EC'
                        ],
                        sympDes: "",
                        sciName: "Pectinophora gossypiella",
                        dName: "Pink Bull Worm",
                        symptoms: [
                          'Feeding damage in flower buds',
                          'Silk threads tie petals togetner',
                          'Feeding holes in cotton bolls',
                          'Grayish-brown moths with brownish, oval-shaped wings ',
                          'Larvae have a white body with wide transverse Dink bands and dark heads',
                          ' The mother moth lays eggs in clusters or singly on the lower sides of young leaves, on young twigs, on buds, on young pods, on bracts.',
                          'The tiny larvae that emerge from the cocoons into the flower and feed on the internal contents, turning them into blind flowers. The tiny larvae make holes in the pods that pare too small to be seen by the eye and enter inside. Later the hole made in the pods gets clogged and the worm stays in the pod and eats the seeds and damages the cotton. Cotton colour and quality are completely damaged.',
                          'As the insect spends the entire larval stage inside the pod, damage can be detected only after the pod is cracked.',
                          ' The pods that affect by the insect will be ripen early without fully developing.'
                        ]);
                    Navigation.instance.navigateTo(
                        PlantDiseaseInfoScreen.id.path,
                        args: infoModel);
                  } else if (output == "Rice Case Worm") {
                    PlantDiseaseInfoModel infoModel = PlantDiseaseInfoModel(
                        pMes:
                            "If possible, use late-maturing varieties to avoid peak populations. Synchronous planting also helps to reduce rice bug problems. Monitor fields for signs of the pest, starting from pre-flowering stage. Remove alternative hosts such as crabgrass, goosegrass and beans. Remove weeds from fields and surrounding areas. Use trap crops around the field to attract rice bugs. Apply a balanced fertilization plan. Water regularly but avoid excessive humidity. Use nets to capture rice bugs, in the early morning or late afternoon. Flood fields to drown the bugs or drive them to the top of the plant, where they are more easily targeted by pesticides. Preserve beneficial insects by spraying less broad-spectrum insecticides (wasps, grasshoppers and spiders)",
                        dName: "Rice Case Worm",
                        sciName: "Leptocorisa spp. ",
                        images: [
                          Assets.pink,
                          Assets.pinkBull,
                          Assets.pink_1
                          //519985176271-adb1088fa94c?ixlib=rb-0.3.5&ixid=eyJhcHBfaWQiOjEyMDd9&s=a0c8d632e977f94e5d312d9893258f59&auto=format&fit=crop&w=1355&q=80'
                        ],
                        symptoms: [
                          "Feeding damage on head",
                          "Unfilled or empty grains",
                          "Discoloration",
                          " Grain deformation",
                          "Confusion with Bacterial Panicle Blight."
                        ],
                        sympDes:
                            "Depending on the growth stage of the rice grain, the feeding can result in empty grains or small, shriveled, deformed grains with a spotty discoloration, sometimes with an offensive smell. Panicles appear erect",
                        tips:
                            "We recommend following organic control methods in the early stages of a disease or when the crop is close to harvesting. In more advanced stages of a disease, please follow chemical control measures. Mixing or applying different products at the same time is not recommended",
                        organicControl:
                            "pray aromatic (like lemongrass) soap solution to expel the rice bug. Use prahok (local 'cheese' in Cambodia) near the field to attract the rice bug and kill it. Use a mosquito net in the early morning or late afternoon to remove the rice bug, crush it and put it in water then spray it to expel other rice bugs. Encourage biological control agents: some wasps, grasshoppers, and spiders attack rice bugs or rice bug eggs",
                        products: [
                          'Imidacloprid 6.0% SL\n,Lambda-cyhalothrin 4.0% SL',
                          "Malathion 50.0% EC"
                        ],
                        rCause:
                            "Rice bugs occurs sporadically during milking to grain filling stage only and emanate foul smell in the evening hours. Immature and adult rice bugs both feed on rice grains. Rice bugs suck out the contents of developing grains. They are actually found in all rice environments. Woodlands, extensive weedy areas near rice fields, wild grasses near canals, and staggered rice planting favors high population densities. They are more active when monsoonal rains begin. Warm weather, overcast skies, and frequent drizzles favor its population build-up. They are less active during the dry season. The symptoms resemble the damage of Bacterial Panicle Blight",
                        pCause:
                            "Mode of damage to cotton crop by pink bollworm is The damage caused by the pink borer is not visible on the surface. It is known only when the pods crack.  Because soon after emerging from the cocoons, the small larvae make invisible holes on the buds or pods and enter and spend their entire life in the pods.  By feeding on the material in the flowers that are growing in anticipation of the tender buds, the attractive leaves are folded rather than unfurled. These are called Guddipulu.  Although the flowers are shed when the mature buds are expected, damage is caused by pollen eating the ovules inside. In this way, the buds and flowers will fall if you expect them in the first stage.  When the tender pods are harvested, they do not fall off, the pod size does not increase, but the pods do not burst properly and dry up, forming blind pods.  To identify the damage of this insect, if you open the eggs and pods in the field and look inside, you will notice small or large pink caterpillars inside the pod. Pink boll weevil can cause loss of cotton colour, quality and weight loss in cotton, resulting in a significant reduction in yield.");
                    Navigation.instance.navigateTo(
                        PlantDiseaseInfoScreen.id.path,
                        args: infoModel);
                  }
                },
                child: Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                        color: Colors.green,
                        borderRadius: BorderRadius.circular(12)),
                    child: const Text("Show Info")),
              ))
        ],
      ),
    );
  }
}
